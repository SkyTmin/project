# Coco Instrument - Модульное веб-приложение для управления финансами

## Описание

Coco Instrument - это Progressive Web Application (PWA) для управления личными финансами. Приложение построено на принципах модульности, что позволяет легко добавлять новые функции.

## Основные возможности

- **Аутентификация пользователей** с верификацией через вчерашнюю дату
- **Coco Money** - модуль для отслеживания доходов и расходов
  - Создание листов доходов
  - Добавление и управление расходами
  - Автоматический расчет баланса
- **PWA функциональность** - работа офлайн, установка как приложение
- **Модульная архитектура** - легкое добавление новых модулей

## Структура проекта

```
coco-instrument/
├── public/                  # Статические файлы (фронтенд)
│   ├── index.html          # Главная HTML страница
│   ├── manifest.json       # PWA манифест
│   ├── sw.js              # Service Worker
│   ├── css/               # Стили
│   │   ├── main.css       # Основные стили
│   │   ├── auth.css       # Стили аутентификации
│   │   └── coco-money.css # Стили модуля Coco Money
│   ├── js/                # JavaScript файлы
│   │   ├── core/          # Ядро приложения
│   │   │   ├── EventBus.js
│   │   │   ├── StateManager.js
│   │   │   ├── APIClient.js
│   │   │   ├── Router.js
│   │   │   └── ModuleManager.js
│   │   ├── modules/       # Модули
│   │   │   ├── AuthModule.js
│   │   │   └── CocoMoneyModule.js
│   │   └── app.js         # Точка входа
│   └── icons/             # Иконки для PWA
├── config/                 # Конфигурация
│   └── db.js              # Настройки базы данных
├── middleware/            # Middleware Express
│   ├── auth.js           # Аутентификация
│   └── errorHandler.js   # Обработка ошибок
├── routes/                # API маршруты
│   ├── auth.js           # Маршруты аутентификации
│   ├── incomeSheets.js   # Маршруты листов доходов
│   └── expenses.js       # Маршруты расходов
├── scripts/               # Вспомогательные скрипты
│   └── migrate.js        # Миграция БД
├── server.js             # Основной серверный файл
├── package.json          # Зависимости Node.js
├── railway.toml          # Конфигурация Railway
├── .env.example          # Пример переменных окружения
└── README.md             # Этот файл
```

## Развертывание на Railway

### Подготовка

1. Создайте аккаунт на [Railway](https://railway.app)
2. Установите Railway CLI (опционально):
   ```bash
   npm install -g @railway/cli
   ```

### Шаги развертывания

1. **Создайте новый проект в Railway Dashboard**

2. **Добавьте сервис PostgreSQL:**
   - В проекте нажмите "New Service"
   - Выберите "Database" → "Add PostgreSQL"
   - Railway автоматически создаст базу данных и предоставит `DATABASE_URL`

3. **Загрузите код:**
   
   Вариант 1 - Через GitHub:
   - Загрузите код в GitHub репозиторий
   - В Railway выберите "New Service" → "GitHub Repo"
   - Выберите ваш репозиторий
   
   Вариант 2 - Через Railway CLI:
   ```bash
   railway login
   railway link
   railway up
   ```

4. **Настройте переменные окружения:**
   
   В Railway Dashboard перейдите в настройки сервиса и добавьте:
   ```
   JWT_SECRET=your-super-secret-key-here-min-32-chars
   NODE_ENV=production
   ```

5. **Проверьте развертывание:**
   - Railway автоматически выполнит миграцию БД и запустит сервер
   - Дождитесь завершения развертывания
   - Откройте предоставленный URL

### Переменные окружения в Railway

Railway автоматически предоставляет:
- `PORT` - порт для сервера
- `DATABASE_URL` - строка подключения к PostgreSQL

Вам нужно добавить вручную:
- `JWT_SECRET` - секретный ключ для JWT (минимум 32 символа)

### Локальная разработка

1. **Установите зависимости:**
   ```bash
   npm install
   ```

2. **Создайте файл `.env`:**
   ```bash
   cp .env.example .env
   ```
   Отредактируйте `.env` и укажите свои значения

3. **Создайте базу данных PostgreSQL локально**

4. **Выполните миграцию:**
   ```bash
   npm run db:migrate
   ```

5. **Запустите сервер:**
   ```bash
   npm run dev   # Для разработки с nodemon
   # или
   npm start     # Для продакшена
   ```

## Безопасность

- Все пароли хешируются с помощью bcrypt
- JWT токены для аутентификации
- HTTPS обязателен в продакшене
- Rate limiting для защиты от брутфорса
- Валидация всех входных данных
- Защита от XSS и CSRF атак

## Добавление новых модулей

1. Создайте файл модуля в `public/js/modules/`
2. Следуйте структуре:
   ```javascript
   const MyModule = {
       id: 'my-module',
       name: 'My Module',
       init() { /* инициализация */ },
       render() { /* отрисовка */ }
   };
   window.moduleManager.register(MyModule);
   ```
3. Добавьте стили в `public/css/`
4. Модуль автоматически интегрируется в систему

## Мониторинг

- Health check endpoint: `/health`
- Логи доступны в Railway Dashboard
- Метрики производительности в Railway Metrics

## Поддержка

При возникновении проблем:
1. Проверьте логи в Railway Dashboard
2. Убедитесь, что все переменные окружения установлены
3. Проверьте статус базы данных
4. Убедитесь, что миграция выполнена успешно

## Исправления и улучшения (версия 1.1)

### Исправленные проблемы:
1. **Устранено дублирование при создании** - листы доходов и расходы теперь создаются только один раз
2. **Исправлены двойные уведомления** - каждое действие показывает только одно уведомление
3. **Изменена логика регистрации** - дата теперь не заполняется автоматически, обновлена подсказка
4. **Улучшен UX** - добавлена главная страница с выбором инструментов
5. **Добавлены подтверждения** - все операции удаления и изменения требуют подтверждения
6. **Исправлено отображение старых данных** - после удаления листа данные корректно очищаются
7. **Исправлена конфигурация Express** - добавлен trust proxy для корректной работы rate limiting
8. **Добавлена функция экспорта** - возможность скачать или скопировать данные листа

### Новые возможности:
- **Главная страница** с выбором инструментов
- **Плавающая кнопка** для быстрого создания листа доходов
- **Модальные окна подтверждения** вместо стандартных alert
- **Экспорт данных** в текстовый формат с возможностью копирования или скачивания
- **Улучшенная навигация** между модулями

### Логи Railway:
Сообщения о checkpoint в логах PostgreSQL являются нормальными и не требуют действий. Ошибки duplicate key обрабатываются корректно и показывают соответствующее сообщение пользователю.

## Лицензия

MIT
